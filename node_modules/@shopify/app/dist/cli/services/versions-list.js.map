{"version":3,"file":"versions-list.js","sourceRoot":"","sources":["../../../src/cli/services/versions-list.ts"],"names":[],"mappings":"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","sourcesContent":["import {fetchOrCreateOrganizationApp, renderCurrentlyUsedConfigInfo} from './context.js'\nimport {fetchOrgFromId} from './dev/fetch.js'\nimport {AppVersionsQuery, AppVersionsQuerySchema} from '../api/graphql/get_versions_list.js'\nimport {AppInterface, isCurrentAppSchema} from '../models/app/app.js'\nimport {getAppIdentifiers} from '../models/app/identifiers.js'\nimport {partnersRequest} from '@shopify/cli-kit/node/api/partners'\nimport {ensureAuthenticatedPartners} from '@shopify/cli-kit/node/session'\nimport {renderTable} from '@shopify/cli-kit/node/ui'\nimport colors from '@shopify/cli-kit/node/colors'\nimport {outputContent, outputInfo, outputToken, unstyled} from '@shopify/cli-kit/node/output'\nimport {formatDate} from '@shopify/cli-kit/common/string'\nimport {AbortError} from '@shopify/cli-kit/node/error'\nimport {basename} from '@shopify/cli-kit/node/path'\n\n// eslint-disable-next-line @typescript-eslint/consistent-type-definitions\ntype AppVersionLine = {\n  createdAt: string\n  createdBy?: string\n  message?: string\n  versionTag: string\n  status: string\n}\n\nconst TABLE_FORMATTING_CHARS = 12\n\nasync function fetchAppVersions(\n  token: string,\n  apiKey: string,\n): Promise<{\n  appVersions: AppVersionLine[]\n  totalResults: number\n  app: AppVersionsQuerySchema['app']\n}> {\n  const query = AppVersionsQuery\n  const res: AppVersionsQuerySchema = await partnersRequest(query, token, {apiKey})\n  if (!res.app) throw new AbortError(`Invalid API Key: ${apiKey}`)\n\n  const appVersions = res.app.appVersions.nodes.map((appVersion) => {\n    const message = appVersion.message ?? ''\n    return {\n      ...appVersion,\n      status: appVersion.status === 'active' ? colors.green(`â˜… ${appVersion.status}`) : appVersion.status,\n      createdBy: appVersion.createdBy?.displayName ?? '',\n      createdAt: formatDate(new Date(appVersion.createdAt)),\n      message,\n    }\n  })\n\n  const maxLineLength = (process.stdout.columns ?? 75) - TABLE_FORMATTING_CHARS\n  let maxMessageLength = maxLineLength\n\n  // Calculate the max allowed length for the message column\n  appVersions.forEach((appVersion) => {\n    const combinedLength =\n      appVersion.message.length +\n      appVersion.versionTag.length +\n      unstyled(appVersion.status).length +\n      appVersion.createdAt.length +\n      appVersion.createdBy.length\n    if (combinedLength > maxLineLength) {\n      const combinedWithoutMessageLength = combinedLength - appVersion.message.length\n      const newMaxLength = Math.max(maxLineLength - combinedWithoutMessageLength, 10)\n      if (newMaxLength < maxMessageLength) {\n        maxMessageLength = newMaxLength\n      }\n    }\n  })\n\n  // Update the message column to fit the max length\n  appVersions.forEach((appVersion) => {\n    if (appVersion.message.length > maxMessageLength) {\n      appVersion.message = `${appVersion.message.slice(0, maxMessageLength - 3)}...`\n    }\n  })\n\n  return {\n    appVersions,\n    totalResults: res.app.appVersions.pageInfo.totalResults,\n    app: res.app,\n  }\n}\n\nasync function getAppApiKey(token: string, options: VersionListOptions): Promise<string> {\n  if (options.apiKey) return options.apiKey\n  const envIdentifiers = getAppIdentifiers({app: options.app})\n  if (envIdentifiers.app) return envIdentifiers.app\n  if (isCurrentAppSchema(options.app.configuration)) return options.app.configuration.client_id\n  const partnersApp = await fetchOrCreateOrganizationApp(options.app, token)\n  return partnersApp.apiKey\n}\n\ninterface VersionListOptions {\n  app: AppInterface\n  apiKey?: string\n}\n\nexport default async function versionList(options: VersionListOptions) {\n  const token = await ensureAuthenticatedPartners()\n  const apiKey = await getAppApiKey(token, options)\n  const {appVersions, totalResults, app} = await fetchAppVersions(token, apiKey)\n\n  const {id: appId, organizationId} = app\n\n  const {businessName: org} = await fetchOrgFromId(organizationId, token)\n  renderCurrentlyUsedConfigInfo({\n    org,\n    appName: app.title,\n    configFile: isCurrentAppSchema(options.app.configuration) ? basename(options.app.configurationPath) : undefined,\n  })\n\n  if (appVersions.length === 0) {\n    outputInfo('No app versions found for this app')\n    return\n  }\n\n  renderTable({\n    rows: appVersions,\n    columns: {\n      versionTag: {header: 'VERSION'},\n      status: {header: 'STATUS'},\n      message: {header: 'MESSAGE'},\n      createdAt: {header: 'DATE CREATED'},\n      createdBy: {header: 'CREATED BY'},\n    },\n  })\n\n  const link = outputToken.link(\n    'Partner Dashboard',\n    `https://partners.shopify.com/${organizationId}/apps/${appId}/versions`,\n  )\n\n  outputInfo(outputContent`\\nView all ${String(totalResults)} app versions in the ${link}`)\n}\n"]}